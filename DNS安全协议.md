						     DNS安全协议
===



1.背景
---

​		DNS系统没有内置方法来是验证用户发送的请求响应是否是伪造的，也没有办法来判断整个过程中的任何部分没有被攻击者中断。这是一个问题，因为用户想要连接到网站时，则必须用DNS来查找，将网站的域名转换为可用的IP地址。如果用户是在一个不安全的网路环境下来进行连接的话，恶意攻击者就有可能对DNS进行攻击，这种攻击可能会修改IP地址的A记录将其重定向与一个不安全的网站。

2.简介
---

​		DNSSEC是DNS安全扩展，它通过给数据进行数据加密的方式，来验证应答消息真实性和完整性，利用密码技术，使得域名解析服务器可以验证它所收到的应答（包括域名不存在的应答）是否来自于真实的服务器，或者是否在传输过程中被篡改过。通过DNSSEC的署可以增强对DNS域名服务器的身份验证，进而帮助防止DNS缓存污染等攻击。需要说明的是，DNSSEC不是对数据进行加密，它只是验证用户所访问的地址是否有效。

​		通过RFC2535可知，DNSSEC提供三种服务，分别是密钥分发、数据来源认证和事物和请求认证。

3.原理
---

​		简单的说，DNSSEC依靠数字签名保证DNS应答报文的真实性和完整性。权威域名服务器用自己的私钥对资源记录（RR）进行签名，解析服务器用权威服务器的公钥对收到的应答信息进行验证。如果验证失败，表明这一报文可能是假冒的，或者在传输过程、缓存过程中被篡改，它的实施步骤如下：

- DNS服务器收到DNS查询请求后，用散列函数将要回复的DNS报文内容进行散列运算，得到“内容摘要”，使用私钥加密后在附加到DNS报文中；
- 用户在接收到应答报文后，利用公钥解密收到的“内容摘要”，再利用散列函数计算一次DNS查询请求报文中的内“内容摘要”，两者进行对比。
- 若相同，就可以确认接收到的DNS信息是正确的DNS响应；若验证失败，则表明这一报文可能是假冒的，或者在数据传输过程、缓存过程中被篡改。

4.DNSSEC资源记录
---

​		为了实现资源记录的签名和验证，DNSSEC增加了四种类型的资源记录：RRSIG、DNSKEY、DS、NSEC。

### 4.1RRSIG记录

​		RRSIG资源记录存储的对资源记录集合的数字签名。下面是对一个A记录签名后得到的RRSIG记录：

![image-20220514141646043](../图片.pn/image-20220514141646043.png)

类型覆盖：表示这个签名覆盖什么类型的资源记录，本列中是A；

算法：数字签名算法，同DNSKEY记录的算法字段，本例中5表示RSA/SHA-1;

标签数量：被签名的资源域名记录所有者（host.example.com.）中的标签数量，本例中为3，“.example.com”为2，“.”为0。

### 4.2DNSKEY记录

​		DNSKEY资源记录存储的是公开密钥，下面是一个DNSKEY的资源记录的例子：

![image-20220514144111274](../图片.pn/image-20220514144111274.png)

256：是标志（flag）字段，它是一个16比特的数字，如果第7位为1，则表明它是一个区密钥，该密钥可以用于签名数据的验证，而且资源记录的所有者必须是区的名字；

3：协议字段，表示这是一个DNSKEY；

5：算法字段，标识签名所使用的算法的种类，其中1->RSA/MD5;3->DSA/SHA-1;5->RSA/SHA-1;

### 4.3DS记录

​		DS（Delegation Signer）记录存储DNSKEY的散列值，用于验证DNSKEY的真实性，从而建立一个信任链。不过，不象DNSKEY存储在资源记录所有者所在的权威域的区文件中，DS记录存储在上级域名服务器（Delegation）中，比如example.com的DS RR存储在.com的区中。
![image-20220514143627861](../图片.pn/image-20220514143627861.png)

### 4.4NSEC记录

​		NSEC记录是为了应答那些不存在的资源记录而设计的。为了保证私有密钥的安全性和服务器的性能，所有的签名记录都是事先（甚至离线）生成的。服务器显然不能为所有不存在的记录事先生成一个公共的“不存在”的签名记录，因为这一记录可以被重放（Replay）；更不可能为每一个不存在的记录生成独立的签名，因为它不知道用户将会请求怎样的记录。

​		在区数据签名时，NSEC记录会自动生成。比如在vpn.test.net和xyz.test.net之间会插入下面的这样两条记录：
![image-20220514143913943](../图片.pn/image-20220514143913943.png)

​		其中NSEC记录包括两项内容：排序后的下一个资源记录的名称（xyz.test.net.）、以及vpn.test.net.这一名称所有的资源记录类型（A、RRSIG、NSEC），后面的RRSIG记录是对这个NSEC记录的数字签名。

5.DNSSEC对现有DNS协议的修改
---

​		由于新增DNS资源记录的尺寸问题，支持DNSSEC的域名服务器必须支持EDNS0（RFC2671），即允许DNS报文大小必须达到1220字节（而不是最初的512字节），甚至可以是4096字节。

DNSSEC在报文头中增加了三个标志位：

（1）DO（DNSSEC OK, 参见RFC3225）：支持DNSSEC的解析服务器在它的DNS查询报文中，必须把DO标志位置1，否则权威域服务器认为解析器不支持DNSSEC就不会返回RRSIG等记录。

（2）AD （Authentic Data）：AD是认证数据标志，如果服务器验证了DNSSEC相关的数字签名，则置AD位为1，否则为0。这一标志位一般用于自己不做验证的解析器（non-validating security-aware resolvers）和它所信任的递归解析服务器（security-aware recursive name server）之间，用户计算机上的解析器自己不去验证数字签名，递归服务器给它一个AD标志为1的响应，它就接受验证结果。这种场景只有在它们之间的通信链路比较安全的情况下才安全，比如使用了IPSEC和TSIG[]。

（3）CD （Checking Disabled）： 关闭检查标志位用于支持DNSSEC验证功能的解析器（validating security-aware resolver）和递归域名服务器之间，解析器在发送请求时把CD位置1，服务器就不再进行数字签名的验证而把递归查询得到的结果直接交给解析器，由解析器自己验证签名的合法性。

最后，支持验证的DNSSEC 解析器对它所收到的资源记录的签名（RRSIG），必须能够区分区分以下四种结果：

（1）安全的（secure）：解析器能够建立到达资源记录签名者的信任链，并且可以验证数字签名的结果是正确的。

（2）不安全的（insecure）：解析器收到了一个资源记录和它的签名，但是它没有到达签名者的信任链，因而无法验证。

（3）伪造的（Bogus）：解析器有一个到资源记录签名者的信任链，但是签名验证是错的。可能是因为受到攻击了，也可能是管理员配置错误。

（4）不确定（Indeterminate）：解析器无法获得足够的DNSSEC 资源记录，因而不能确定用户所请求的资源记录是否应该签名。
